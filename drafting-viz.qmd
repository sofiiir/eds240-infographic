---
title: "drafting-viz"
format: html
author: Sofia Rodas
message: false
warning: false
---
# Global bat data exploration

This data was acquired from the open-source project intended to aggregate data for bats that live in karsts and caves. This data project is called [DarkCideS 1.0](https://darkcides.wordpress.com/). 

- What regions have the most bat studies? 

- What are bats feeding habits and ecosystem needs?

- What regions of the world have the greatest extinction risks for bats?

```{r}
#| message: false
#| warning: false

# load in necessary libraries
library(tidyverse)
library(camcorder) # to save an iteration of all of the visuals made in this qmd
library(png)
library(plotly)
library(ggtext)
library(sf)
library(tmap)
library(cowplot) # to layer tmap and ggplot
library(ggplotify)
```
I'm excited to see what camcorder creates from the visuals I make for this qmd. 
```{r}
gg_record(
  dir = file.path(here::here("data", "recording100")), # where to save the recording
  device = "png", # device to use to save images
  width = 4,      # width of saved image
  height = 6,     # height of saved image
  units = "in",   # units for width and height
  dpi = 300       # dpi to use when saving image
)
```


```{r}
#| message: false
#| warning: false

# read in data
bats <- read_csv(here::here("data", "figshare-bat-data", "Dataset_1.csv")) |> 
  janitor::clean_names()
```

### What are the different feeding groups in observed bats from caves and karsts?

Big bat broken up into feeding groups. 

### What ecosystems are bats that live in caves found in most often?
These values are held in columns that are dummy variables. They need to be cleaned for the graphing process. The end goal of the cleaning is a row for each combination of species and ecosystem type.

### Does feeding group influence which ecosystem cave bats frequent? 

I want to create a bar graph that shows how many bats were observed globally in each feeding group. 
```{r}
# calculate number of bats per feeding groups
bat_feeding_groups<- bats |> 
  group_by(feeding_groups) |> 
  summarise(value = n()) |> 
  arrange(value)

# create a bar plot displaying number of bat per feeding group
ggplot(bat_feeding_groups) +
  geom_col(aes(value, feeding_groups))+
  theme_minimal() +
  theme(axis.title = element_blank()) +
  labs(title = "Number of Bats per Feeding Group")
  
```
Define colors
```{r}
carnivore <- "#E6AA60"
sanguivore <- "#883955"
frugivore <- "#C4EBC8"
insectivore <- "#587792"
nectarivore <- "#D7A6B3"
omnivore <- "#07004D"
        
```

Make this info into one stacked barplot.
```{r}
ggplot(bat_feeding_groups, aes(fill= feeding_groups, y=value, x = "")) +
  geom_bar(position="fill", stat="identity") +
  scale_fill_manual(values = c(carnivore,
                               frugivore,
                               insectivore,
                               nectarivore,
                               omnivore,
                               sanguivore))+
  labs(y = "Percentage")+
  theme_minimal() + 
  theme(axis.title.x = element_blank()) 
```
Make a percentage column.
```{r}
sum_feed <- sum(bat_feeding_groups$value)

bat_feeding_groups <- bat_feeding_groups |> 
  mutate(percentage = (value/sum_feed))
```


```{r}
# bat_img <- readPNG(here::here("data", "noun-bat-8134648.png"))
# h <- dim(bat_img) [1]
# w <- dim(bat_img) [2]
```

```{r}
# Find the rows where feet starts and head ends
# pos1 <- which(apply(bat_img[,,1], 1, function(y) any(y==1)))
# mn1 <- min(pos1)
# mx1 <- max(pos1)
# pospct <- round((mx1-mn1)* bat_feeding_groups$percentage/100+mn1)
```
```{r}
# dim(bat_img)
```


```{r}
# imgmtx <- bat_img[h:1,,1]
# whitemtx <- (imgmtx==1)
# colmtx <- matrix(rep(FALSE,h*w),nrow=h)
# midpt <- round(w/2)-10
# colmtx[mx1:pospctM,1:midpt] <- TRUE
# colmtx[mx1:pospctF,(midpt+1):w] <- TRUE
# imgmtx[whitemtx & colmtx] <- 0.5
```

#### What ecosystems are bats that live in caves found in most often?
These values are held in columns that are dummy variables. They need to be cleaned for the graphing process. The end goal of the cleaning is a row for each combination of species and ecosystem type.

```{r}
# convert the dummy variables into one tidy column
ecosystem_bats <- bats |> 
  select(species_name, forest, savanna, dessert, urban, cave) |> 
  mutate(forest = case_when(forest == 1 ~ "forest", 
                            forest == 0 ~ NA)) |> 
  mutate(savanna = case_when(savanna == 1 ~ "savanna", 
                              savanna == 0 ~ NA)) |> 
  mutate(desert = case_when(dessert == 1 ~ "desert",
                            dessert == 0 ~ NA))  |> 
  mutate(urban = case_when(urban == 1 ~ "urban",
                           urban == 0 ~ NA)) |> 
  mutate(cave = case_when(cave == 1 ~ "cave",
                          cave == 0 ~ NA)) |> 
  pivot_longer(cols = c(forest, savanna, desert, urban, cave),
               names_to = "ecosystem_type",
               values_to = "ecosystem") |> 
  filter(!is.na(ecosystem)) |> 
  select(species_name, ecosystem)
```
Calculate the number of bats in each ecosystem. A caveat is that each species can be in more than one ecosystem.
```{r}
ecosystem_bat_values <- ecosystem_bats |> 
  group_by(ecosystem) |> 
  summarise(value = n()) |> 
  arrange(value) |> 
  ungroup()
```
Create a visual to show where cave bats are most likely to be observed.
```{r}
ggplot(ecosystem_bat_values, aes(x = "", y = value, fill = ecosystem)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() + 
  labs(title = "Ecosystem Locations of Bat Observations")
```

```{r fig.height= 10, fig.width= 10}
ecosystem_bat_values |> 
  arrange(value) |> 
ggplot(aes(x= fct_inorder(ecosystem), 
           y = value + 100, 
           color = ecosystem, 
           fill = ecosystem)) +
  ggforce::geom_link(aes(x = ecosystem, 
                         xend = ecosystem,
                         y = 0,
                         yend = value + 100,
                         color = ecosystem,
                         color = after_scale(colorspace::desaturate(color, .3))),
                     n = 30,
                     size = 2) +
    ggpattern::geom_tile_pattern(fill = "transparent",
                                 pattern = "image",
                                 pattern_filename = here::here("data", "noun-bat-8134648.png")) +
#  geom_text(aes(label = value)) + 
   annotate(geom = "segment",
            x = 0.95, xend = 5.5,
             y = 1, yend = 1,
            linewidth = 0.6) +
  scale_color_manual(values = c("#E4B9C8",
                                "#74B2BC",
                                "#5D7D4D",
                                "#FAE7AE",
                                "#DA6767"
                                )) + 
  coord_polar(theta = "y", start = 7, clip = "off") +
  theme_minimal() + 
  theme(panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.title.x = element_blank(),
        axis.text = element_blank()) +
  labs(title = "Cave and karst  residing bats researched?",
       subtitle = "Cave and karst bats are seen most often in forests",
       x = "")
  
```

```{r}
# ecosystem_bat_values <- ecosystem_bat_values |> 
#   mutate(image = list(readPNG(here::here("data", "noun-bat-8134648.png"))))
```

Trouble shooting how to add the bats to the plot.
```{r}
 ggplot(ecosystem_bat_values, aes(x = ecosystem, y = value)) +
  ggpattern::geom_tile_pattern(
    fill = "transparent",
    pattern = "image",
    pattern_filename = here::here("data", "noun-bat-8134648.png")) 
```
# Cave bats location data and landscape vulnerabilities
```{r}
#| warning: false
#| message: false

cave_bats <- read_csv(here::here("data", "figshare-bat-data", "Dataset_2.csv")) |> 
  janitor::clean_names() |> 
  rename(latitude = lattitude)

landscape_vul <- read_csv(here::here("data", "figshare-bat-data", "Dataset_3.csv")) |> 
  janitor::clean_names()

bat_parasites <- read_csv(here::here("data", "figshare-bat-data", "Dataset_4.csv")) |> 
  janitor::clean_names()
```


This data contains longitdue and latitude data so lets convert it to geospatial data
```{r}
geo_cave_bats <- st_as_sf(cave_bats, coords = c("longitude", "latitude"), crs = st_crs(4326))
geo_landscape_vul <- st_as_sf(landscape_vul, coords = c("longitude", "latitude"), crs = st_crs(4326))


geo_cave_bats <- st_transform(geo_cave_bats, 3857)
geo_landscape_vul <- st_transform(geo_landscape_vul, 3857)
```

Initial plot of the data. 
```{r}
bat_dist <- tm_basemap("CartoDB.DarkMatter") +
  tm_shape(geo_cave_bats) + 
  tm_dots(fill = "#FBA2C6", 
          fill_alpha = 0.4)  

# change the basemap to a grob to layer with the ggplots
grob_bat <- tmap_grob(bat_dist)
```

Distribution plot of where bat observations are most seen.
```{r}
dist_cave_bats <-
  cave_bats |> 
  ggplot(aes(longitude)) +
    geom_density(
      color = colorspace::darken("#FBA2C6", .2, space ="HLS"),
      fill = "#FBA2C6",
      alpha = .6,
      size = .3,
      bw = .5
    ) +
  theme(
      panel.background = element_rect(
        color = "transparent",
        fill = "transparent"
      ),
      plot.background = element_rect(
        color = "transparent",
        fill = "transparent"
      ),
      plot.margin = margin(b = -1.4, t = 1.6),
      axis.title = element_blank(),
      axis.text = element_blank()
    )

```
Filter for caves that are relatively close to urban areas and highly populous locations. 
```{r}
pop_vul_caves <- landscape_vul |> 
  filter(urban_dist < 1001 | pop_dens > 500) 
```

```{r}
dist_pop_vul <- pop_vul_caves |> 
  ggplot(aes(longitude)) +
    geom_density(
      color = colorspace::darken("#ED570B", .2, space ="HLS"),
      fill = "#ED570B",
      alpha = .6,
      size = .3,
      bw = .5
    ) +
  theme(
      panel.background = element_rect(
        color = "transparent",
        fill = "transparent"
      ),
      plot.background = element_rect(
        color = "transparent",
        fill = "transparent"
      ),
      plot.margin = margin(b = -1.4, t = 1.6),
      axis.title = element_blank(),
      axis.text = element_blank()
    ) + 
  scale_y_reverse()
```

```{r}
ggdraw(grob_bat) + 
  draw_plot(dist_cave_bats,
            x =  .5,
            y = .663,
            width = 1.008,
            height = .34,
            hjust = .5,
            vjust = -0.3) +
  draw_plot(dist_pop_vul, 
            x = .5,
            y = .24,
            width = 1.008,
            height = .565,
            hjust = .5,
            vjust = 1)

  
```

