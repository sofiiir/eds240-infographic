---
title: "exploration"
format: html
message: false
warning: false
---
# Global bat data exploration

This data was acquired from the open-source project intended to aggregate data for bats that live in karsts and caves. This data project is called [DarkCideS 1.0](https://darkcides.wordpress.com/). 

What does the bat data show?
```{r}
#| message: false
#| warning: false

# load in necessary libraries
library(tidyverse)
library(sf)
library(tmap)
```

```{r}
#| message: false
#| warning: false

# read in data
bats <- read_csv(here::here("data", "figshare-bat-data", "Dataset_1.csv")) |> 
  janitor::clean_names()
```

### What are the different feeding groups in observed bats from caves and karsts?
```{r}
unique(bats$feeding_groups)
```
 I want to create a bar graph that shows how many bats were observed globally in each feeding group. 
```{r}
# calculate number of bats per feeding groups
bat_feeding_groups<- bats |> 
  group_by(feeding_groups) |> 
  summarise(value = n()) |> 
  arrange(value)

# create a bar plot displaying number of bat per feeding group
ggplot(bat_feeding_groups) +
  geom_col(aes(value, feeding_groups))+
  theme_minimal() +
  theme(axis.title = element_blank()) +
  labs(title = "Number of Bats per Feeding Group")
  
```


#### How many species are represented in this dataset?
```{r}
length(unique(bats$species))
```
Too many unique species to effectively display in a visual. 
 
#### What ecosystems are bats that live in caves found in most often?
These values are held in columns that are dummy variables. They need to be cleaned for the graphing process. The end goal of the cleaning is a row for each combination of species and ecosystem type.

```{r}
# convert the dummy variables into one tidy column
ecosystem_bats <- bats |> 
  select(species_name, forest, savanna, dessert, urban, cave) |> 
  mutate(forest = case_when(forest == 1 ~ "forest", 
                            forest == 0 ~ NA)) |> 
  mutate(savanna = case_when(savanna == 1 ~ "savanna", 
                              savanna == 0 ~ NA)) |> 
  mutate(desert = case_when(dessert == 1 ~ "desert",
                            dessert == 0 ~ NA))  |> 
  mutate(urban = case_when(urban == 1 ~ "urban",
                           urban == 0 ~ NA)) |> 
  mutate(cave = case_when(cave == 1 ~ "cave",
                          cave == 0 ~ NA)) |> 
  pivot_longer(cols = c(forest, savanna, desert, urban, cave),
               names_to = "ecosystem_type",
               values_to = "ecosystem") |> 
  filter(!is.na(ecosystem)) |> 
  select(species_name, ecosystem)
```
Calculate the number of bats in each ecosystem. A caveat is that each species can be in more than one ecosystem.
```{r}
ecosystem_bat_values <- ecosystem_bats |> 
  group_by(ecosystem) |> 
  summarise(value = n()) |> 
  arrange(value) |> 
  ungroup()
```
Create a visual to show where cave bats are most likely to be observed.
```{r}
ggplot(ecosystem_bat_values, aes(x = "", y = value, fill = ecosystem)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() + 
  labs(title = "Ecosystem Locations of Bat Observations")
```
#### Does feeding group influence which ecosystem cave bats frequent? 
 
```{r}
# join two datasets to get feeding group and ecosystem type
bat_eco_feeding <- full_join(ecosystem_bats, bats, by = "species_name")

# select only the necessary columns
bat_eco_feeding <- bat_eco_feeding |> 
  select(species_name, ecosystem, feeding_groups)

# calculate values for each ecosystem feeding group combination
bat_eco_feeding <- bat_eco_feeding |> 
  group_by(ecosystem, feeding_groups) |> 
  summarise(value = n()) |> 
  arrange(value) |> 
  filter(!is.na(ecosystem)) |> 
  ungroup()
  
```

```{r}
ggplot(bat_eco_feeding) +
  geom_col(aes(value, feeding_groups), fill = "darkblue") +
  facet_wrap(~ecosystem) + 
  theme_minimal()
```

```{r}
# bats |> 
#   group_by()
```


# Convert longitude and latitude into geospatial data
```{r}
#| warning: false
#| message: false

geo1 <- read_csv(here::here("data", "figshare-bat-data", "Dataset_2.csv")) |> 
  janitor::clean_names() |> 
  rename(latitude = lattitude)

geo2 <- read_csv(here::here("data", "figshare-bat-data", "Dataset_3.csv")) |> 
  janitor::clean_names()

geo3 <- read_csv(here::here("data", "figshare-bat-data", "Dataset_4.csv")) |> 
  janitor::clean_names()
```
Join the data frames together
```{r}
full_geo <- full_join(geo1, geo2)
```
```{r}
south_amer <- geo2 |> 
  filter(region == "South America")

south_amer_geo <- st_as_sf(south_amer, coords = c("latitude", "longitude"), crs = 3857)


tm_basemap() 
# tm_shape(south_amer_geo) + 
#   tm_dots(fill = "red")
```


This data contains longitdue and latitude data but I want this to be geospatial data
```{r}
bat_geo1 <- st_as_sf(geo1, coords = c("longitude", "latitude"), crs = st_crs(4326))
bat_geo2 <- st_as_sf(geo2, coords = c("longitude", "latitude"), crs = st_crs(4326))
bat_geo <- st_as_sf(full_geo, coords = c("longitude", "latitude"), crs = st_crs(4326))

bat_geo1 <- st_transform(bat_geo1, 3857)
bat_geo2 <- st_transform(bat_geo2, 3857)
bat_geo <- st_transform(bat_geo, 3857)
```

 
```{r}
tm_basemap("OpenStreetMap") +
tm_shape(bat_geo) + 
  tm_dots(fill = "red")  
```

```{r}
tm_basemap("OpenStreetMap") +
tm_shape(bat_geo1) + 
  tm_dots(fill = "red") 
```

```{r}
tm_basemap("Esri.WorldTopoMap") +
tm_shape(bat_geo2) + 
  tm_dots(fill = "red") 
```


1. What have you learned about your data? Have any potentially interesting patterns emerged? Point to specific visualizations that you created as you describe your findings.

The bats that reside in caves and karsts, studied around the world are most likely to be insectivores, followed by frugivores, and omnivores as shown in the first bar plot. The pie chart shows that most bats have been observed in forests closely followed by caves. One of the most interesting aspects of faceting bat observations by ecosystem is that most bats observed in urban areas are frugivores. 

2. In FPM #1, you outlined some questions that you wanted to answer using these data. Have you made any strides towards answering those questions? If yes, how so? If no, what next steps do you need to take (e.g. I need to create X plot type, I still need to track down Y data, I need to restructure existing data so that you can visualize it in Z ways, etc.)? Have any new questions emerged?

I originally was interested in looking at white-nose synodrome in bats across North America, however after much research it is proving difficult to find white nose syndrome data that is readily available. I did find bat data that is a comprehensive summary of bat data from around the world. I plan to answer:

- What regions have the most bat studies? 

- What are bats feeding habits and ecosystem needs?

- What regions of the world have the greatest extinction risks for bats?

3. What challenges do you foresee encountering with your data? These can be data wrangling and / or visualization challenges.  
The exploration of the data and the plots constructed above are based on one of the four datasets that were downloaded. I need to explore how I will use the other datasets which almost exclusively include longitude and latitude of species observed around the world.  I plan to make at least one geo-spatial visualization which may prove difficult since the observations are global and this will be a challenge to fit into the final infographic with other plots. 
 
